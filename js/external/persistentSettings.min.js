var persistentSettingLockFile=System.Gadget.path+"\\persistentSettingsLockFile.txt";var persistentSettingFile=System.Gadget.path+"\\persistentSettings.txt";var persistentSettingTempFile=System.Gadget.path+"\\persistentSettings.tmp.txt";var persistentSettingDelimiter="~~~~~";var persistentSettingRegExpFormatString=persistentSettingDelimiter+"(..*)"+persistentSettingDelimiter+"(.*)";var persistentSettingQueue=new Array();var persistentSettingPendingTimeouts=0;var persistentSettingFailedRetries=0;function getPersistentSetting(a,c){if((c==undefined)||(c==null)){var b="getPersistentSetting: you must specify a callback function";persistentSettingLog(b);throw b}persistentSettingQueue.push({operation:"get",name:a,callback:c});window.setTimeout(processPersistentSettingQueue,0);persistentSettingPendingTimeouts++}function setPersistentSetting(a,b,c){persistentSettingQueue.push({operation:"set",name:a,value:b,callback:c});window.setTimeout(processPersistentSettingQueue,0);persistentSettingPendingTimeouts++}function processPersistentSettingQueue(){try{persistentSettingPendingTimeouts--;if(persistentSettingQueue.length==0){return}var b=new ActiveXObject("Scripting.FileSystemObject");try{var c=null;try{c=b.CreateTextFile(persistentSettingLockFile,false)}catch(f){if(persistentSettingPendingTimeouts==0){if(persistentSettingFailedRetries>600){throw"maximum lock retries exceeded"}persistentSettingFailedRetries++;persistentSettingPendingTimeouts++;window.setTimeout(processPersistentSettingQueue,100)}return}try{persistentSettingFailedRetries=0;while(persistentSettingQueue.length>0){var d=null;var a=persistentSettingQueue.shift();if(a.operation=="set"){setPersistentSettingInternal(a.name,a.value)}else{if(a.operation=="get"){d=getPersistentSettingInternal(a.name)}}if((a.callback!=undefined)&&(a.callback!=null)){persistentSettingScheduleCallback(a.callback,d)}}}finally{c.Close();b.DeleteFile(persistentSettingLockFile,true)}}finally{b=null}}catch(f){persistentSettingFailFast(f.name+": "+f.message)}}function persistentSettingScheduleCallback(b,a){window.setTimeout(function(){try{b(a)}catch(c){persistentSettingLog("exception from callback: "+c.name+": "+c.message)}},0)}function setPersistentSettingInternal(b,k){var h=new ActiveXObject("Scripting.FileSystemObject");try{var c=null;try{c=h.GetFile(persistentSettingFile)}catch(i){var l=h.CreateTextFile(persistentSettingFile);try{l.WriteLine(persistentSettingDelimiter+b+persistentSettingDelimiter+k)}finally{l.Close()}return}oldSettings=c.OpenAsTextStream(1);try{var a=false;var m=new RegExp(persistentSettingRegExpFormatString);var f=h.CreateTextFile(persistentSettingTempFile,true);try{while(!oldSettings.AtEndOfStream){var n=oldSettings.ReadLine();var g=n.match(m);var j=g[1];var d=g[2];if(b==j){f.WriteLine(persistentSettingDelimiter+b+persistentSettingDelimiter+k);a=true}else{f.WriteLine(persistentSettingDelimiter+j+persistentSettingDelimiter+d)}}if(!a){f.WriteLine(persistentSettingDelimiter+b+persistentSettingDelimiter+k)}}finally{f.Close()}}finally{oldSettings.Close()}h.DeleteFile(persistentSettingFile,true);h.MoveFile(persistentSettingTempFile,persistentSettingFile)}finally{h=null}}function getPersistentSettingInternal(a){var f=new ActiveXObject("Scripting.FileSystemObject");try{var c=null;try{c=f.GetFile(persistentSettingFile)}catch(g){return null}settings=c.OpenAsTextStream(1);try{var i=new RegExp(persistentSettingRegExpFormatString);while(!settings.AtEndOfStream){var j=settings.ReadLine();var d=j.match(i);var h=d[1];var b=d[2];if(a==h){return b}}}finally{settings.Close()}return null}finally{f=null}}function persistentSettingLog(a){System.Debug.outputString("PersistentSettings.js: "+a+"\n")}function persistentSettingFailFast(a){persistentSettingLog("FAILFAST: "+a);System.Gadget.close()};